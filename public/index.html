<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Checkout</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      :root {
        --bg: #ececec;
        --panel: #f4f4f4;
        --card: #ffffff;
        --line: #d8d8d8;
        --text: #2e2e2e;
        --muted: #717171;
        --primary: #5d6774;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .layout {
        min-height: 100vh;
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
      .left {
        border-right: 1px solid var(--line);
        padding: 24px 28px;
      }
      .brand {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 30px;
        font-weight: 700;
        margin-bottom: 24px;
        letter-spacing: 0.5px;
      }
      .brand .dot {
        color: #f0b323;
      }
      .product {
        max-width: 360px;
        font-size: 38px;
        line-height: 1.2;
      }
      .price {
        margin-top: 12px;
        font-size: 62px;
        font-weight: 700;
      }
      .right {
        background: var(--panel);
        padding: 18px 18px 28px;
      }
      .checkout {
        max-width: 540px;
        margin: 0 auto;
      }
      h2 {
        margin: 0 0 12px;
        font-size: 32px;
      }
      h3 {
        font-size: 22px;
        margin: 18px 0 10px;
      }
      .field-label {
        margin: 10px 0 6px;
        color: #525252;
        font-size: 18px;
      }
      #setup-form {
        display: grid;
        gap: 12px;
      }
      .stripe-field {
        background: var(--card);
        border: 1px solid #cfcfcf;
        border-radius: 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      #link-authentication-element,
      #shipping-address-element {
        padding: 10px;
      }
      #payment-element {
        padding: 12px 10px;
      }
      .payment-stack {
        display: grid;
        gap: 14px;
      }
      .payment-method-header {
        display: flex;
        align-items: center;
        gap: 14px;
        font-size: 40px;
        font-weight: 600;
      }
      .radio-dot {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 5px solid #000;
        box-shadow: inset 0 0 0 3px #fff;
        background: #000;
      }
      .card-icon {
        width: 30px;
        height: 24px;
        border-radius: 4px;
        background: #000;
        position: relative;
      }
      .card-icon::before {
        content: "";
        position: absolute;
        left: 5px;
        right: 5px;
        top: 6px;
        height: 3px;
        background: #fff;
      }
      .card-icon::after {
        content: "";
        position: absolute;
        left: 5px;
        bottom: 5px;
        width: 6px;
        height: 4px;
        background: #fff;
      }
      .line-field {
        background: var(--card);
        border: 1px solid #cfcfcf;
        border-radius: 8px;
        padding: 12px 10px;
      }
      .card-shell {
        background: var(--card);
        border: 1px solid #cfcfcf;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
      }
      .card-top {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        align-items: center;
        padding: 12px 14px;
        border-bottom: 1px solid #cfcfcf;
      }
      .brand-chips {
        display: flex;
        gap: 6px;
      }
      .chip {
        border: 1px solid #cfcfcf;
        border-radius: 4px;
        padding: 3px 5px;
        font-size: 11px;
        font-weight: 700;
        background: #fff;
      }
      .card-bottom {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
      .card-bottom > div {
        padding: 12px 14px;
      }
      .card-bottom > div:first-child {
        border-right: 1px solid #cfcfcf;
      }
      .line-input {
        width: 100%;
        background: var(--card);
        border: 1px solid #cfcfcf;
        border-radius: 8px;
        padding: 12px 10px;
        font-size: 16px;
      }
      .check-row {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
      }
      .check-row input {
        width: 22px;
        height: 22px;
      }
      .label-big {
        font-size: 18px;
        color: #525252;
      }
      .billing-box {
        background: var(--card);
        border: 1px solid #cfcfcf;
        border-radius: 12px;
        overflow: hidden;
      }
      .billing-box .row {
        padding: 12px 14px;
      }
      .billing-box .row + .row {
        border-top: 1px solid #cfcfcf;
      }
      .manual-link {
        margin-top: -6px;
        font-size: 16px;
        color: #555;
        text-decoration: underline dotted;
        width: fit-content;
      }
      button {
        margin-top: 4px;
        width: 100%;
        padding: 14px;
        border: 0;
        border-radius: 10px;
        background: #c2c9d1;
        color: #3a4450;
        font-size: 30px;
        cursor: pointer;
      }
      #message {
        min-height: 22px;
        font-size: 14px;
      }
      @media (max-width: 980px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .left {
          border-right: 0;
          border-bottom: 1px solid var(--line);
        }
        .product {
          font-size: 30px;
        }
        .price {
          font-size: 48px;
        }
      }
    </style>
  </head>
  <body>
    <main class="layout">
      <section class="left">
        <div class="brand"><span class="dot">‚óè</span>lume</div>
        <div class="product">Escitalux (Escitalopram 4.4 mg | L-methylfolate 15 mg)</div>
        <div class="price">$29.67</div>
      </section>
      <section class="right">
        <div class="checkout">
          <h2>Shipping information</h2>
          <form id="setup-form">
            <div class="field-label">Email</div>
            <div id="link-authentication-element" class="stripe-field"></div>

            <div class="field-label">Shipping address</div>
            <div id="shipping-address-element" class="stripe-field"></div>

            <h3>Payment method</h3>
            <div id="payment-element" class="payment-stack">
              <div class="payment-method-header">
                <span class="radio-dot"></span>
                <span class="card-icon"></span>
                <span>Card</span>
              </div>

              <div class="label-big">Card information</div>
              <div class="card-shell">
                <div class="card-top">
                  <div id="card-number-element"></div>
                  <div class="brand-chips">
                    <span class="chip">VISA</span>
                    <span class="chip">MC</span>
                    <span class="chip">AMEX</span>
                    <span class="chip">DISC</span>
                  </div>
                </div>
                <div class="card-bottom">
                  <div id="card-expiry-element"></div>
                  <div id="card-cvc-element"></div>
                </div>
              </div>

              <label class="check-row">
                <input id="billing-same" type="checkbox" checked />
                <span>Billing info is same as shipping</span>
              </label>

              <div class="label-big">Cardholder name</div>
              <input id="cardholder-name" class="line-input" placeholder="Full name on card" />

              <div class="label-big">Billing address</div>
              <div class="billing-box">
                <div class="row">
                  <select id="billing-country" class="line-input" style="border:0;padding:0;background:transparent;">
                    <option value="US">United States</option>
                    <option value="CA">Canada</option>
                    <option value="GB">United Kingdom</option>
                    <option value="AU">Australia</option>
                  </select>
                </div>
                <div class="row">
                  <input id="billing-line1" class="line-input" style="border:0;padding:0;" placeholder="Address" />
                </div>
              </div>
              <div class="manual-link">Enter address manually</div>
              <input id="postal-code" class="line-input" placeholder="ZIP code" autocomplete="postal-code" />
            </div>
            <button type="submit">Pay</button>
            <p id="message"></p>
          </form>
        </div>
      </section>
    </main>

    <script>
      const form = document.getElementById("setup-form");
      const messageEl = document.getElementById("message");
      let stripe;
      let elements;
      let linkElement;
      let addressElement;
      let cardNumberElement;
      let cardExpiryElement;
      let cardCvcElement;
      let userEmail = "";
      let setupIntentClientSecret = "";

      async function setupStripe() {
        const configRes = await fetch("/config");
        const config = await configRes.json();
        stripe = Stripe(config.publishableKey);

        const customerRes = await fetch("/create-customer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        const customerData = await customerRes.json();
        if (!customerRes.ok) {
          throw new Error(customerData.error || "Could not create customer");
        }

        const setupIntentRes = await fetch("/create-setup-intent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ customerId: customerData.customerId })
        });
        const setupIntentData = await setupIntentRes.json();
        if (!setupIntentRes.ok) {
          throw new Error(setupIntentData.error || "Could not create SetupIntent");
        }
        setupIntentClientSecret = setupIntentData.clientSecret;

        elements = stripe.elements({
          clientSecret: setupIntentClientSecret,
          appearance: { theme: "stripe" }
        });

        linkElement = elements.create("linkAuthentication");
        linkElement.mount("#link-authentication-element");
        linkElement.on("change", (event) => {
          userEmail = event.value && event.value.email ? event.value.email : "";
        });

        addressElement = elements.create("address", {
          mode: "shipping",
          autocomplete: { mode: "automatic" }
        });
        addressElement.mount("#shipping-address-element");

        cardNumberElement = elements.create("cardNumber");
        cardNumberElement.mount("#card-number-element");
        cardExpiryElement = elements.create("cardExpiry");
        cardExpiryElement.mount("#card-expiry-element");
        cardCvcElement = elements.create("cardCvc");
        cardCvcElement.mount("#card-cvc-element");
      }

      function setMessage(msg, isError = false) {
        messageEl.textContent = msg;
        messageEl.style.color = isError ? "crimson" : "green";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        setMessage("Saving card...");

        try {
          const addressResult = await addressElement.getValue();
          const address = addressResult && addressResult.value ? addressResult.value : {};
          const billingSame = document.getElementById("billing-same").checked;
          const cardholderName = document.getElementById("cardholder-name").value.trim();
          const billingCountry = document.getElementById("billing-country").value;
          const billingLine1 = document.getElementById("billing-line1").value.trim();
          const postalCode = document.getElementById("postal-code").value.trim();
          const billingAddress = billingSame
            ? {
                ...(address.address || {}),
                postal_code: postalCode || (address.address && address.address.postal_code) || undefined
              }
            : {
                line1: billingLine1 || undefined,
                country: billingCountry || undefined,
                postal_code: postalCode || undefined
              };

          const result = await stripe.confirmCardSetup(setupIntentClientSecret, {
            payment_method: {
              card: cardNumberElement,
              billing_details: {
                email: userEmail || undefined,
                name: cardholderName || address.name || undefined,
                address: billingAddress
              }
            }
          });

          if (result.error) {
            throw new Error(result.error.message);
          }

          setMessage(
            `Card saved. SetupIntent ${result.setupIntent.id} is ${result.setupIntent.status}.`
          );
        } catch (err) {
          setMessage(err.message, true);
        }
      });

      setupStripe().catch((err) => setMessage(err.message, true));
    </script>
  </body>
</html>
