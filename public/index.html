<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Checkout</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      :root {
        --bg: #ececec;
        --panel: #f4f4f4;
        --card: #ffffff;
        --line: #d8d8d8;
        --text: #2e2e2e;
        --muted: #717171;
        --primary: #5d6774;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .layout {
        min-height: 100vh;
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
      .left {
        border-right: 1px solid var(--line);
        padding: 28px 32px;
      }
      .brand {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 30px;
        font-weight: 700;
        margin-bottom: 24px;
        letter-spacing: 0.5px;
      }
      .brand .dot {
        color: #f0b323;
      }
      .product {
        max-width: 360px;
        font-size: 20px;
        line-height: 1.35;
      }
      .price {
        margin-top: 10px;
        font-size: 54px;
        font-weight: 700;
      }
      .right {
        background: var(--panel);
        padding: 28px 22px 34px;
      }
      .checkout {
        max-width: 470px;
        margin: 0 auto;
      }
      h2 {
        margin: 0 0 8px;
        font-size: 38px;
        line-height: 1.1;
      }
      h3 {
        font-size: 26px;
        margin: 18px 0 8px;
      }
      .field-label {
        margin: 8px 0 6px;
        color: #525252;
        font-size: 16px;
      }
      #setup-form {
        display: grid;
        gap: 10px;
      }
      .stripe-field {
        background: var(--card);
        border: 1px solid #cfcfcf;
        border-radius: 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      #link-authentication-element,
      #shipping-address-element {
        padding: 10px;
      }
      #payment-element {
        padding: 8px;
      }
      button {
        margin-top: 6px;
        width: 100%;
        padding: 13px;
        border: 0;
        border-radius: 10px;
        background: #c2c9d1;
        color: #3a4450;
        font-size: 43px;
        line-height: 1;
        font-weight: 500;
        cursor: pointer;
      }
      #message {
        min-height: 22px;
        font-size: 14px;
        margin: 6px 2px 0;
      }
      @media (max-width: 980px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .left {
          border-right: 0;
          border-bottom: 1px solid var(--line);
        }
        .product {
          font-size: 18px;
        }
        .price {
          font-size: 42px;
        }
      }
    </style>
  </head>
  <body>
    <main class="layout">
      <section class="left">
        <div class="brand"><span class="dot">‚óè</span>lume</div>
        <div class="product">Escitalux (Escitalopram 4.4 mg | L-methylfolate 15 mg)</div>
        <div class="price">$29.67</div>
      </section>
      <section class="right">
        <div class="checkout">
          <h2>Shipping information</h2>
          <form id="setup-form">
            <div class="field-label">Email</div>
            <div id="link-authentication-element" class="stripe-field"></div>

            <div class="field-label">Shipping address</div>
            <div id="shipping-address-element" class="stripe-field"></div>

            <h3>Payment method</h3>
            <div id="payment-element" class="stripe-field"></div>
            <button type="submit">Pay</button>
            <p id="message"></p>
          </form>
        </div>
      </section>
    </main>

    <script>
      const form = document.getElementById("setup-form");
      const messageEl = document.getElementById("message");
      let stripe;
      let elements;
      let linkElement;
      let addressElement;
      let paymentElement;
      let userEmail = "";
      let setupIntentClientSecret = "";

      async function setupStripe() {
        const configRes = await fetch("/config");
        const config = await configRes.json();
        stripe = Stripe(config.publishableKey);

        const customerRes = await fetch("/create-customer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        const customerData = await customerRes.json();
        if (!customerRes.ok) {
          throw new Error(customerData.error || "Could not create customer");
        }

        const setupIntentRes = await fetch("/create-setup-intent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ customerId: customerData.customerId })
        });
        const setupIntentData = await setupIntentRes.json();
        if (!setupIntentRes.ok) {
          throw new Error(setupIntentData.error || "Could not create SetupIntent");
        }
        setupIntentClientSecret = setupIntentData.clientSecret;

        elements = stripe.elements({
          clientSecret: setupIntentClientSecret,
          appearance: { theme: "stripe" }
        });

        linkElement = elements.create("linkAuthentication");
        linkElement.mount("#link-authentication-element");
        linkElement.on("change", (event) => {
          userEmail = event.value && event.value.email ? event.value.email : "";
        });

        addressElement = elements.create("address", {
          mode: "shipping",
          autocomplete: { mode: "automatic" }
        });
        addressElement.mount("#shipping-address-element");

        paymentElement = elements.create("payment", {
          layout: "tabs",
          paymentMethodOrder: ["card"],
          fields: {
            billingDetails: {
              email: "never",
              name: "auto",
              address: "auto"
            }
          }
        });
        paymentElement.mount("#payment-element");
      }

      function setMessage(msg, isError = false) {
        messageEl.textContent = msg;
        messageEl.style.color = isError ? "crimson" : "green";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        setMessage("Saving card...");

        try {
          const submitResult = await elements.submit();
          if (submitResult.error) {
            throw new Error(submitResult.error.message);
          }

          const result = await stripe.confirmSetup({
            elements,
            redirect: "if_required",
            confirmParams: {
              payment_method_data: {
                billing_details: {
                  email: userEmail || undefined
                }
              }
            }
          });

          if (result.error) {
            throw new Error(result.error.message);
          }

          setMessage(
            `Card saved. SetupIntent ${result.setupIntent.id} is ${result.setupIntent.status}.`
          );
        } catch (err) {
          setMessage(err.message, true);
        }
      });

      setupStripe().catch((err) => setMessage(err.message, true));
    </script>
  </body>
</html>
